<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Guess my number</title>
    <style>
      body {
        font-family: "Montserrat", "Calibri-Light", Arial, sans-serif;
        margin: 0;
      }
      #wrapper {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #f9f9f9;
        margin: 0 auto;
        height: 100vh;
      }
      #userInput {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: flex-end;
      }
      #guessInput {
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: flex-end;
      }
      #message {
        color: #c71585;
      }
      #restart {
        display: none;
      }
      button {
        font-family: "Montserrat", "Calibri-Light", Arial, sans-serif;
        font-size: 100%;
        border-radius: 100px;
        border: 1.3px solid #8f095d;
        background: #8f095d;
        color: #fff;
        width: 18rem;
        padding: 0.3rem;
      }
      input {
        font-family: "Montserrat", "Calibri-Light", Arial, sans-serif;
        font-size: 100%;
        color: #aaa;
        padding: 0.3rem 0.6rem;
        margin-left: 0.3rem;
        border-radius: 100px;
        border: 0.1rem solid #ddd;
        background: none;
        width: 18rem;
        box-sizing: border-box;
      }
      h1 {
        margin-top: 0;
      }
      input:focus,
      button:focus {
        outline: none;
      }
      button:active {
        background-color: #6b174c;
        border-color: #6b174c;
      }
    </style>
  </head>

  <body>
    <div id="wrapper">
      <h1 id="title">Guess my number</h1>
      <p id="hint">
        Enter your Username to join the multiplayer guess my number game.
      </p>

      <div id="userInput">
        <p>
          <span id="user"> Username: </span><input id="userName" type="text" />
        </p>
        <button id="start">Start</button>
      </div>

      <p id="bounds"></p>
      <p id="message"></p>
      <p id="users"></p>

      <div id="guessInput">
        <p>
          <span id="yourGuess">Your Guess:</span>
          <input id="number" type="number" />
        </p>
        <button id="guess">Guess</button>
      </div>

      <button id="restart">Restart Game</button>
    </div>
    <script>
      const USER_LANG = navigator.language.substring(0, 2);
      const DEFAULT_LANGUAGE = "en";
      const LAN_KEY = {
        TITLE: "TITLE",
        BOUNDS: "BOUNDS",
        HELLO: "HELLO",
        PLAYERS: "PLAYERS",
        PICK: "PICK",
        USERNAME: "USERNAME",
        RETRY: "RETRY",
        HINT: "HINT",
        START: "START",
        GUESS: "GUESS",
        YOUR_GUESS: "YOUR_GUESS"
      };
      const TEXTS = {
        en: {
          TITLE: "Guess my number",
          BOUNDS: "Guess a number between the two bounds: ",
          HELLO: "Hello",
          PLAYERS: "Number of players: ",
          PICK: "Pick a username!",
          USERNAME: "Username: ",
          RETRY: "Retry, your number must be between those bounds. ",
          HINT:
            "Enter your Username to join the multiplayer guess my number game.",
          START: "Start",
          GUESS: "Guess",
          YOUR_GUESS: "Your Guess: "
        },

        de: {
          TITLE: "Errate meine Zahl",
          BOUNDS: "Errate die Zahl zwischen den zwei Grenzen: ",
          HELLO: "Hallo",
          PLAYERS: "Anzahl der Spieler: ",
          PICK: "WÃ¤hle einen Benutzernamen!",
          USERNAME: "Benutzername: ",
          RETRY:
            "Versuche es nochmal, die Zahl muss zwischen den zwei Grenzen liegen.",
          HINT:
            "Gib einen Benutzernamen ein, um dem Mehrspieler-Spiel 'Errate-meine-Zahl' beizutreten.",
          START: "Start",
          GUESS: "Rate",
          YOUR_GUESS: "Deine Vermutung: "
        }
      };

      console.log(language("TITLE"));

      let start = document.getElementById("start");
      let guess = document.getElementById("guess");
      let number = document.getElementById("number");
      let bounds = document.getElementById("bounds");
      let userInput = document.getElementById("userInput");
      let guessInput = document.getElementById("guessInput");
      let message = document.getElementById("message");
      let restart = document.getElementById("restart");
      let hint = document.getElementById("hint");
      let users = document.getElementById("users");
      let user = document.getElementById("user");
      let title = document.getElementById("title");
      let yourGuess = document.getElementById("yourGuess");

      let min;
      let max;
      let name;

      //initial language setup
      user.innerHTML = language(LAN_KEY.USERNAME);
      title.innerHTML = language(LAN_KEY.TITLE);
      hint.innerHTML = language(LAN_KEY.HINT);
      start.innerHTML = language(LAN_KEY.START);
      guess.innerHTML = language(LAN_KEY.GUESS);
      yourGuess.innerHTML = language(LAN_KEY.YOUR_GUESS);

      start.addEventListener("click", function(evt) {
        const nameInput = document.getElementById("userName");
        startGame(nameInput);
      });

      guess.addEventListener("click", function(evt) {
        makeGuess(number);
      });

      restart.addEventListener("click", function(evt) {
        location.reload(true);
      });

      function language(KEY) {
        // Remember this function needs to do something.
        let value = TEXTS[USER_LANG][KEY];
        if (!value) {
          value = TEXTS[DEFAULT_LANGUAGE][KEY];
          console.error(
            `Person that wrote the ${USER_LANG} made a mistake with key ${KEY}`
          );
        }
        return value;
      }

      async function startGame(nameInput) {
        try {
          if (nameInput) {
            name = nameInput.value;
            if (name.length > 0) {
              let result = await fetch(
                `https://guess-number-meindl.herokuapp.com/start/${name}`
              );
              if (result.ok) {
                let data = await result.json();
                min = data.min;
                max = data.max;
                bounds.innerHTML = `${language(
                  LAN_KEY.HELLO
                )} ${name}! ${language(LAN_KEY.BOUNDS)} ${min} - ${max}.`;

                hint.style.display = "none";
                userInput.style.display = "none";
                guessInput.style.display = "flex";
                message.innerHTML = "";
                number.min = min;
                number.max = max;
              }
            } else {
              message.innerHTML = language(LAN_KEY.PICK);
            }
          }
        } catch (error) {
          console.log(error);
        }
      }

      async function makeGuess(number) {
        try {
          if (number) {
            const guessedNumber = number.value;
            if (guessedNumber >= min && guessedNumber <= max) {
              let result = await fetch(
                `https://guess-number-meindl.herokuapp.com/guess/${name}/${guessedNumber}`,
                {
                  method: "POST",
                  mode: "no-cors",
                  cache: "no-cache",
                  credentials: "same-origin",
                  headers: {
                    "Content-Type": "application/json"
                  },
                  redirect: "follow",
                  referrer: "no-referrer"
                }
              );
              if (result.ok) {
                let data = await result.json();
                message.innerHTML = data.msg;
                users.innerHTML = language(LAN_KEY.PLAYERS) + data.users;

                if (data.code == 2000 || data.code == 2030) {
                  restart.style.display = "block";
                  guessInput.style.display = "none";
                  message.style.color = "#a3c227";
                }
              }
            } else {
              message.innerHTML = language(LAN_KEY.RETRY);
            }
          }
        } catch (error) {
          console.log(error);
        }
      }
    </script>
  </body>
</html>
